#include <Adafruit_NeoPixel.h>

#define LED_PIN 16
#define BUTTON_PIN 10
#define NUM_LEDS 1
#define LED1_PIN 48
#define LID_OPEN_DETECT 46
#define HOTFAN_PIN 7
#define CSFAN_PIN 21

#define CSFAN_CURR_PIN 14
#define HSFAN_CURR_PIN 15

#define VOLTAGE_PIN 4
#define DIVIDER_RATIO 11

#define AMBIENT_PIN 8
#define COLDSINK_PIN 3
#define HEATSINK_PIN 9
#define FLASKTOP_PIN 11

#define SR_SER 13
#define SR_SRCLK 44
#define SR_RCLK 43

#define VREF 3.3
#define ADC_MAX 4095
#define R_FIXED 10000
#define BETA 3977
#define R0 10000
#define T0 298.15
#define GAIN 100.0

#define CSSHUNT_RESISTOR 0.3
#define HSSHUNT_RESISTOR 0.05

Adafruit_NeoPixel led(NUM_LEDS, LED_PIN, NEO_GRB + NEO_KHZ800);

int ledState = 0;
int lastButtonState = HIGH;
int lastLidState = HIGH;
///////////////////////////////////
int adcValue;
float inputVoltage;

float readVoltage(int pin) {
  int val = analogRead(pin);
  return (val * VREF) / ADC_MAX;
}

float voltageToResistance(float voltage) {
  if (voltage <= 0)
    return NAN;
  return R_FIXED * (2.5 / voltage - 1.0);
}

float resistanceToTempC(float resistance) {
  float tempK = 1.0 / ((log(resistance / R0) / BETA) + (1.0 / T0));
  return tempK - 273.15;
}
////////////////////////
void setup() {
  Serial.begin(115200);
  analogReadResolution(12);

  pinMode(BUTTON_PIN, INPUT_PULLUP);
  pinMode(LID_OPEN_DETECT, INPUT_PULLUP);
  pinMode(LED1_PIN, OUTPUT);
  pinMode(HOTFAN_PIN, OUTPUT);
  pinMode(CSFAN_PIN, OUTPUT);

  led.begin();
  led.show();
}

void loop() {
  while (1) {
    int currentButton = digitalRead(BUTTON_PIN);
    int currentLidState = digitalRead(LID_OPEN_DETECT);

    if (currentLidState != lastLidState)
     {
      if (currentLidState == LOW) {
        Serial.println("LID CLOSED");
        if (ledState == 1) 
        {
          led.setPixelColor(0, led.Color(255, 0, 0));
          digitalWrite(LED1_PIN, HIGH);
          digitalWrite(HOTFAN_PIN, HIGH);
          digitalWrite(CSFAN_PIN, HIGH);
        } else {
          led.setPixelColor(0, led.Color(0, 0, 0));
          digitalWrite(LED1_PIN, LOW);
        }
        led.show();
      } else 
      {
        Serial.println("LID OPEN");
        led.setPixelColor(0, led.Color(0, 0, 0));  // off immediately
        digitalWrite(LED1_PIN, LOW);
        digitalWrite(HOTFAN_PIN, LOW);
        digitalWrite(CSFAN_PIN, LOW);
        led.show();
      }
      lastLidState = currentLidState;
    }
    if (lastButtonState == HIGH && currentButton == LOW) {
      ledState = !ledState;

      if (ledState == 1) 
      {
        led.setPixelColor(0, led.Color(255, 0, 0));
        digitalWrite(LED1_PIN, HIGH);
        digitalWrite(HOTFAN_PIN, HIGH);
        digitalWrite(CSFAN_PIN, HIGH);
      } else 
      {
        led.setPixelColor(0, led.Color(0, 0, 0));
        digitalWrite(LED1_PIN, LOW);
        digitalWrite(HOTFAN_PIN, LOW);
        digitalWrite(CSFAN_PIN, LOW);
      }
      led.show();
    }
    lastButtonState = currentButton;
    ///////////////////////////////////////////////////
    const long interval = 1000;
    static unsigned long previousMillis = 0;

    unsigned long currentMillis = millis();
    if (currentMillis - previousMillis >= interval) 
    {
      previousMillis = currentMillis;
    /////////////////////////////////////////
    float vA = readVoltage(AMBIENT_PIN);
    float vC = readVoltage(COLDSINK_PIN);
    float vH = readVoltage(HEATSINK_PIN);
    float vF = readVoltage(FLASKTOP_PIN);

    float tA = resistanceToTempC(voltageToResistance(vA));
    float tC = resistanceToTempC(voltageToResistance(vC));
    float tH = resistanceToTempC(voltageToResistance(vH));
    float tF = resistanceToTempC(voltageToResistance(vF));

    int adcCold = analogRead(CSFAN_CURR_PIN);
    delayMicroseconds(10);
    float voutCold = (adcCold * VREF) / ADC_MAX;
    float currentCold = voutCold / (GAIN * CSSHUNT_RESISTOR);

    int adcHot = analogRead(HSFAN_CURR_PIN);
    delayMicroseconds(10);
    float voutHot = (adcHot * VREF) / ADC_MAX;
    float currentHot = voutHot / (GAIN * HSSHUNT_RESISTOR);

    adcValue = analogRead(VOLTAGE_PIN);
    inputVoltage = (((float)adcValue / ADC_MAX) * VREF) * DIVIDER_RATIO;

    Serial.printf("Ambient: %.2f 째C\n", tA);
    Serial.printf("Cold Sink: %.2f 째C\n", tC);
    Serial.printf("Heat Sink: %.2f 째C\n", tH);
    Serial.printf("Flask Top: %.2f 째C\n", tF);

    Serial.print("Current CSFAN: ");
    Serial.print(currentCold);
    Serial.println(" A");

    Serial.print("Current HSFAN: ");
    Serial.print(currentHot);
    Serial.println(" A");

    Serial.print("Voltage: ");
    Serial.print(inputVoltage);
    Serial.println(" V");
  }
}
}
